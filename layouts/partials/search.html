<button
  id="search-btn"
  type="button"
  aria-label="Search notes"
  aria-haspopup="dialog"
  class="flex items-center gap-2 cursor-pointer border rounded-full border-(--ef-bg-4) p-2 sm:py-1"
>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <circle cx="11" cy="11" r="8"/>
    <path d="m21 21-4.35-4.35"/>
  </svg>
  <span class="text-xs">Search</span>
  <span class="hidden sm:block" aria-hidden="true">
    <kbd>Ctrl</kbd><kbd class="ml-1">K</kbd>
  </span>
</button>

<dialog id="search-dialog">
  <div class="p-3 border-b flex items-center gap-2">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="shrink-0" aria-hidden="true">
      <circle cx="11" cy="11" r="8"/>
      <path d="m21 21-4.35-4.35"/>
    </svg>
    <input
      id="search-input"
      type="search"
      placeholder="Search notesâ€¦"
      autocomplete="off"
      spellcheck="false"
      class="flex-1 font-body text-sm bg-transparent outline-none"
    >
  </div>
  <div id="search-results" class="max-h-80 overflow-y-auto"></div>
</dialog>

<script>
  (() => {
    let pf;
    const dialog = document.getElementById('search-dialog');
    const btn    = document.getElementById('search-btn');
    const input  = document.getElementById('search-input');
    const results = document.getElementById('search-results');

    async function ensurePagefind() {
      if (!pf) {
        try {
          pf = await import('/pagefind/pagefind.js');
          await pf.init();
        } catch {
          console.warn('Search index not available. Run `pnpm build` first.');
        }
      }
      return pf;
    }

    async function openSearch() {
      dialog.showModal();
      await ensurePagefind();
      input.focus();
      if (input.value) renderResults(input.value);
    }

    btn.addEventListener('click', openSearch);

    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
    });

    dialog.addEventListener('click', e => {
      if (e.target === dialog) dialog.close();
    });

    dialog.addEventListener('close', () => {
      results.innerHTML = '';
      input.value = '';
    });

    let timer;
    input.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(() => renderResults(input.value), 150);
    });

    async function renderResults(query) {
      const q = query.trim();
      if (!q) { results.innerHTML = ''; return; }

      const lib = await ensurePagefind();
      if (!lib) return;

      const { results: hits } = await lib.search(q);
      const data = await Promise.all(hits.slice(0, 8).map(r => r.data()));

      if (!data.length) {
        results.innerHTML = '<p class="px-4 py-6 text-center text-sm">No results</p>';
        return;
      }

      results.innerHTML = data.map(r => `
        <a href="${r.url}" class="flex flex-col gap-0.5 px-4 py-3 border-b last:border-none no-underline search-result">
          <span class="text-sm font-headings font-bold">${r.meta.title ?? r.title}</span>
          <span class="text-xs line-clamp-2 [&_mark]:bg-(--ef-mark-bg) [&_mark]:text-(--ef-mark-fg) [&_mark]:rounded-xs [&_mark]:px-0.5">${r.excerpt}</span>
        </a>
      `).join('');
    }
  })();
</script>
